import streamlit as st
import json
import google.generativeai as genai
# main.py ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹å‰æã§ã™
from main import update_opinion_form 

# ==========================================
# ã€æœ€å„ªå…ˆã€‘ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼æ©Ÿèƒ½ï¼ˆã“ã‚Œã‚ˆã‚Šä¸‹ã¯ä½•ãŒã‚ã£ã¦ã‚‚è¡¨ç¤ºã•ã›ãªã„ï¼‰
# ==========================================
def check_password():
    """èªè¨¼ãŒæˆåŠŸã—ãŸå ´åˆã¯Trueã€å¤±æ•—ã—ãŸå ´åˆã¯å…¥åŠ›æ¬„ã‚’è¡¨ç¤ºã—ã¦Falseã‚’è¿”ã™"""
    # Secretsã«è¨­å®šãŒãªã„å ´åˆã®è­¦å‘Š
    if "APP_PASSWORD" not in st.secrets:
        st.error("ç®¡ç†ç”»é¢ã®Secretsã§ 'APP_PASSWORD' ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        st.stop()

    def password_entered():
        if st.session_state["password"] == st.secrets["APP_PASSWORD"]:
            st.session_state["password_correct"] = True
            del st.session_state["password"] 
        else:
            st.session_state["password_correct"] = False

    if "password_correct" not in st.session_state:
        # æœ€åˆã®ç”»é¢ï¼šãƒ­ã‚´ã‚‚ã‚¿ã‚¤ãƒˆãƒ«ã‚‚å‡ºã•ãšã€å…¥åŠ›æ¬„ã®ã¿
        st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", type="password", on_change=password_entered, key="password")
        return False
    elif not st.session_state["password_correct"]:
        # é–“é•ãˆãŸå ´åˆ
        st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", type="password", on_change=password_entered, key="password")
        st.error("ğŸ˜• ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™")
        return False
    else:
        # æ­£è§£
        return True

# èªè¨¼ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œã€‚å¤±æ•—ãªã‚‰ã“ã“ã§ã‚¢ãƒ—ãƒªã‚’å¼·åˆ¶åœæ­¢ã€‚
if not check_password():
    st.stop()

# ==========================================
# 0. ãƒšãƒ¼ã‚¸è¨­å®š & ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ– (ã“ã“ã‹ã‚‰å…ˆãŒã‚¢ãƒ—ãƒªã®ä¸­èº«)
# ==========================================
st.set_page_config(page_title="ä¸»æ²»åŒ»æ„è¦‹æ›¸ ä½œæˆãã‚“ v9.1 (åˆå›ãƒ»æ›´æ–°å¯¾å¿œç‰ˆ)", layout="wide")

if "json_data" not in st.session_state:
    st.session_state.json_data = None
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []

# ã‚¿ã‚¤ãƒˆãƒ«ã®è¡¨ç¤º (ã“ã“ã‹ã‚‰ã‚¢ãƒ—ãƒªã®ç”»é¢ãŒå§‹ã¾ã‚Šã¾ã™)

# ==========================================
# â˜…è¨­å®šã‚¨ãƒªã‚¢ (Secretså¯¾å¿œç‰ˆ)
# ==========================================

# 1. ã¾ãšã€éš ã—ãƒ•ã‚¡ã‚¤ãƒ«(secrets.toml)ã‚„ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®šã‹ã‚‰ã‚­ãƒ¼ã‚’æ¢ã™
if "MY_API_KEY" in st.secrets:
    MY_API_KEY = st.secrets["MY_API_KEY"]
else:
    # è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç©ºã«ã—ã¦ãŠãï¼ˆã‚ã¨ã§å…¥åŠ›æ¬„ã‚’å‡ºã™ãŸã‚ï¼‰
    MY_API_KEY = None

# Geminiã®è¨­å®š
if MY_API_KEY:
    genai.configure(api_key=MY_API_KEY)

# ãƒ¢ãƒ‡ãƒ«è¨­å®š
MODEL_NAME = "gemini-3-flash-preview"

TEMPLATE_FILE = "ä¸»æ²»åŒ»æ„è¦‹æ›¸_ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.xlsx"
OUTPUT_FILE = "ä¸»æ²»åŒ»æ„è¦‹æ›¸_å®Œæˆç‰ˆ.xlsx"

# ==========================================
# 1. ç”»åƒåˆ†æãƒ­ã‚¸ãƒƒã‚¯ (v9.0ãƒ™ãƒ¼ã‚¹ + åˆå›å¯¾å¿œ)
# ==========================================
IMAGE_LOGIC_RULES = """
ã€æœ€é‡è¦ï¼šç”»åƒåˆ†æã¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®ãƒ­ã‚¸ãƒƒã‚¯ (v9.1)ã€‘
æä¾›ã•ã‚ŒãŸç”»åƒã‚’ä»¥ä¸‹ã®å½¹å‰²ã§å³å¯†ã«åŒºåˆ¥ã—ã€æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’å®Ÿè¡Œã›ã‚ˆã€‚

â—† ä½œæˆãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹æŒ™å‹•ã®é•ã„
* **åˆå›(æ–°è¦)ã®å ´åˆ**: ç”»åƒ1ãƒ»2ï¼ˆéå»ï¼‰ã¯å­˜åœ¨ã—ãªã„ã€‚ç”»åƒ3ãƒ»4ï¼ˆä»Šå›ï¼‰ã®æƒ…å ±ã®ã¿ã‹ã‚‰å…¨ã¦ã®é …ç›®ã‚’æ–°è¦ã«æ±ºå®šã›ã‚ˆã€‚ã€Œéå»ã®ç¶­æŒã€ãƒ«ãƒ¼ãƒ«ã¯é©ç”¨ã—ãªã„ã€‚
* **æ›´æ–°(2å›ç›®ä»¥é™)ã®å ´åˆ**: ç”»åƒ1ãƒ»2ï¼ˆéå»ï¼‰ã‚’çµ¶å¯¾åŸºæº–ã¨ã—ã€ç”»åƒ3ãƒ»4ï¼ˆä»Šå›ï¼‰ã§å¤‰æ›´ç‚¹ã‚’æ¢ã›ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã›ã‚ˆã€‚

â—† ç”»åƒã®å½¹å‰² (æ›´æ–°ãƒ¢ãƒ¼ãƒ‰æ™‚)
1. **ç”»åƒ1(è¡¨Before)** / 2. **ç”»åƒ2(è£Before)** â†’ **çµ¶å¯¾åŸºæº–ï¼ˆãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼‰**
   - åŸå‰‡ã¨ã—ã¦ã€ã“ã“ã®æƒ…å ±ã¯ã€Œç¶­æŒã€ã™ã‚‹å¯¾è±¡ã§ã‚ã‚‹ã€‚
3. **ç”»åƒ3(å•è¨ºEvidence)** / 4. **ç”»åƒ4(ã‚«ãƒ«ãƒ†Evidence)** â†’ **å¤‰æ›´ãƒ»è¿½åŠ ã®ãŸã‚ã®æ ¹æ‹ **
   - ã“ã“ã«æ–°ã—ã„æƒ…å ±ï¼ˆæ–°ã—ã„å—è¨ºç§‘ã€çŠ¶æ…‹ã®å¤‰åŒ–ï¼‰ãŒã‚ã‚Œã°ã€ãã‚Œã‚’ã€Œåæ˜ ã€ã™ã‚‹ã€‚

â—† ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹(â–¡/â– )ã®ç‰©ç†çš„åˆ¤å®šãƒ«ãƒ¼ãƒ«
* **é»’ãå¡—ã‚Šã¤ã¶ã•ã‚Œã¦ã„ã‚‹(â– )**ã€ã¾ãŸã¯**ãƒ¬ç‚¹(âœ”)ãŒã‚ã‚‹**å ´åˆã®ã¿ã€Œæœ‰(CHECKED)ã€ã¨åˆ¤å®šã™ã‚‹ã€‚
* ç™½ã„å››è§’(â–¡)ã‚„ã€ã‚´ãƒŸãƒ»æ±šã‚Œã¯ã€Œç„¡(UNCHECKED)ã€ã¨åˆ¤å®šã™ã‚‹ã€‚

â—† 5å¤§ç¦æ­¢ãƒ»å¼·åˆ¶ãƒ«ãƒ¼ãƒ«ï¼ˆã“ã“ã‚’é–“é•ã†ã¨åŒ»ç™‚äº‹æ•…ã«ãªã‚‹ãŸã‚å³å®ˆã›ã‚ˆï¼‰

ã€ãƒ«ãƒ¼ãƒ«â‘ ï¼šä»–ç§‘å—è¨ºã®ç¶­æŒã¨è¿½åŠ ï¼ˆéä¸è¶³ç¦æ­¢ï¼‰ã€‘
* **éå»ã®ç¶­æŒ(æ›´æ–°æ™‚)**: ç”»åƒ1ãƒ»2ï¼ˆéå»ï¼‰ã§ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹è¨ºç™‚ç§‘ã¯ã€ä»Šå›ã‚‚å¿…ãšãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ï¼ˆç¶­æŒã™ã‚‹ï¼‰ã€‚
* **æ–°è¦ã®è¿½åŠ **: ç”»åƒ3ãƒ»4ï¼ˆå•è¨ºãƒ»ã‚«ãƒ«ãƒ†ï¼‰ã«ã€Œçš®è†šç§‘ã€ã€Œçœ¼ç§‘ã€ãªã©ã®è¨˜è¼‰ãŒã‚ã‚Œã°ã€**è¿·ã‚ãšæ–°ãŸã«è¿½åŠ ã§ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã“ã¨ã€‚**
* **ç–¾æ‚£åã‹ã‚‰ã®åˆ¤æ–­**: ç”»åƒ3ãƒ»4ã«æ²»ç™‚ä¸­ã®ç–¾æ‚£åã®è¨˜è¼‰ãŒã‚ã‚Œã°è©²å½“ã™ã‚‹ç§‘ã‚’**è¿·ã‚ãšæ–°ãŸã«è¿½åŠ ã§ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã“ã¨ã€‚** (ä¾‹ï¼šçˆªç™½ç™¬â†’çš®è†šç§‘ã€ç™½å†…éšœâ†’çœ¼ç§‘)

ã€ãƒ«ãƒ¼ãƒ«â‘¡ï¼šè‡ªç«‹åº¦ã®ç¾çŠ¶ç¶­æŒï¼ˆå‹æ‰‹ãªå¤‰æ›´ç¦æ­¢ï¼‰ã€‘
* **åŸå‰‡ç¶­æŒ(æ›´æ–°æ™‚)**: éšœå®³é«˜é½¢è€…ãƒ»èªçŸ¥ç—‡é«˜é½¢è€…ã®è‡ªç«‹åº¦ã¯ã€ç”»åƒ1ï¼ˆéå»ï¼‰ã®ãƒ©ãƒ³ã‚¯ã‚’åŸºæº–ã¨ã™ã‚‹ã€‚
* **è»½é‡åŒ–ã®ç¦æ­¢**: ç”»åƒ3ï¼ˆå•è¨ºç¥¨ï¼‰ã«ã€ŒåŠ‡çš„ã«æ”¹å–„ã—ãŸã€ã€Œå®Œå…¨ã«è‡ªç«‹ã—ãŸã€ã¨ã„ã†æ˜ç¢ºãªè¨¼æ‹ ãŒãªã„é™ã‚Šã€**ãƒ©ãƒ³ã‚¯ã‚’å‹æ‰‹ã«è»½ãï¼ˆJ1ã‚„A1ã€Iãªã©ã¸ï¼‰å¤‰æ›´ã—ã¦ã¯ãªã‚‰ãªã„ã€‚**
* **æ‚ªåŒ–ã®åˆ¤æ–­**: å•è¨ºç¥¨ã‹ã‚‰æ‚ªåŒ–ã¨ã¿ãªã›ã‚‹å ´åˆã¯é©å®œãƒ©ãƒ³ã‚¯ã‚’ä¸Šã’ã‚‹ã€‚ãŸã ã—ã€ç„¡é—‡ã«é‡ç—‡åŒ–ã•ã›ã‚‹ã“ã¨ã¯é¿ã‘ã‚‹ã“ã¨ã€‚
* **è¿·ã£ãŸã‚‰éå»ï¼ˆç”»åƒ1ï¼‰ã®ãƒ©ãƒ³ã‚¯ã‚’ãã®ã¾ã¾æ›¸ãå†™ã›ã€‚**

ã€ãƒ«ãƒ¼ãƒ«â‘¢ï¼šèº«ä½“çŠ¶æ…‹ã®åˆ¤å®šï¼ˆã‚»ãƒƒãƒˆå…¥åŠ›ãƒ»èºŠèº‡ç¦æ­¢ï¼‰ã€‘
* éº»ç—º(I11), ç­‹åŠ›ä½ä¸‹(I17), æ‹˜ç¸®(CC17), é–¢ç¯€ç—›(I19), å¤±èª¿(I21), è¤¥ç˜¡(I23), çš®è†šç–¾æ‚£(BU23)ã«ã¤ã„ã¦ï¼š
  1. ç”»åƒ3(å•è¨ºç¥¨)ã‚„ç”»åƒ4(ã‚«ãƒ«ãƒ†)ã«ã€Œç—›ã¿ã€ã€Œå¼±åŒ–ã€ã€Œæ‹˜ç¸®ã€ç­‰ã®è¨˜è¼‰ãŒã‚ã‚Œã°ã€**è¿·ã‚ãšãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã“ã¨ã€‚**
  2. (æ›´æ–°æ™‚) éƒ¨ä½ã‚„ç¨‹åº¦ãŒä¸æ˜ãªå ´åˆã¯ã€**ç”»åƒ1ãƒ»2ï¼ˆéå»ï¼‰ã®éƒ¨ä½ãƒ»ç¨‹åº¦ã‚’å¼·åˆ¶çš„ã«å¼•ãç¶™ã„ã§ã‚»ãƒƒãƒˆå®Œäº†ã¨ã›ã‚ˆã€‚**

ã€ãƒ«ãƒ¼ãƒ«â‘£ï¼šåŒ»å­¦çš„ç®¡ç†ï¼ˆæŒŸã¿æ’ƒã¡å¯¾ç­–ï¼‹è¦–è¦šå„ªå…ˆï¼‹è»¢è¨˜åŠ ç­†ï¼‹çŸ›ç›¾æ’é™¤ï¼‰ã€‘
* è¡€åœ§, ç§»å‹•, æ‘‚é£Ÿ, é‹å‹•, åš¥ä¸‹ ã«ã¤ã„ã¦ã€‚
* **æ‰‹é †1ï¼šå¢ƒç•Œç·šã®å®šç¾©ï¼ˆã€Œé‹å‹•ã€ãªã©ã®æŒŸã¾ã‚ŒãŸé …ç›®ã¸ã®å¯¾ç­–ï¼‰**
  - **ç§»å‹•ãƒ»é‹å‹•ãƒ»æ‘‚é£Ÿãƒ»åš¥ä¸‹ã®ç¯„å›²**:
    - é …ç›®åã‹ã‚‰é–‹å§‹ã—ã€å³å´ã«ã‚ã‚‹ã€Œâ–¡ç‰¹ã«ãªã—ã€ã€Œâ–¡æœ‰(ã¾ãŸã¯ã‚ã‚Š)ã€ã® **2ã¤ã®å››è§’ã‚’è¦‹ã¤ã‘ã‚‹ã¾ã§ã¯ã€éš£ã®é …ç›®ã®æ–‡å­—ãŒè¦‹ãˆã¦ã‚‚è¦–ç·šã‚’æ­¢ã‚ã¦ã¯ãªã‚‰ãªã„ã€‚**
    - ã€Œéš£ã®æ–‡å­—ã€ã‚ˆã‚Šã‚‚ã€Œè‡ªåˆ†ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€ã‚’å„ªå…ˆã—ã¦ç¢ºä¿ã›ã‚ˆã€‚
  - **è¡€åœ§ã®ç¯„å›²**: ã€Œè¡€åœ§ã€ã‹ã‚‰é–‹å§‹ã—ã€å³å´ã®ã€Œç§»å‹•ã€ç­‰ã®ä»–é …ç›®ãŒå‡ºã¦ããŸã‚‰åœæ­¢ã™ã‚‹ã€‚
* **æ‰‹é †2ï¼šç‰©ç†ãƒã‚§ãƒƒã‚¯ã®ç¢ºèªï¼ˆè¦–è¦šçµ¶å¯¾å„ªå…ˆï¼‰**
  - å®šç¾©ã•ã‚ŒãŸã€Œç¯„å›²å†…ã€ã«ã‚ã‚‹ç”»åƒ2ï¼ˆéå»ï¼‰ã®ãƒã‚§ãƒƒã‚¯ã‚’è¦‹ã‚‹ã€‚
  - **ã€Œâ–  æœ‰ï¼ˆã¾ãŸã¯ã‚ã‚Šï¼‰ã€ãªã‚‰ã€å¿…ãšã€Œæœ‰ï¼ˆã¾ãŸã¯ã‚ã‚Šï¼‰ã€ã‚’é¸æŠã™ã‚‹ã€‚**ï¼ˆãƒãƒ¼ã‚¯ãŒæ–‡å­—ã‚ˆã‚Šå…ˆã«æ¥ã‚‹å ´åˆã‚‚å«ã‚€ï¼‰
  - **ã€Œâ–  ç‰¹ã«ãªã—ã€ãªã‚‰ã€å¿…ãšã€Œç‰¹ã«ãªã—ã€ã‚’é¸æŠã™ã‚‹ã€‚**
* **æ‰‹é †3ï¼šæ–‡ç« ã®ç¶™æ‰¿ã¨åŠ ç­†ï¼ˆçµ¶å¯¾ãƒ«ãƒ¼ãƒ«ï¼‰**
  - **è»¢è¨˜**: ç”»åƒ2ï¼ˆéå»ï¼‰ã®ã€Œæœ‰ã€ã®æ¨ªã«ã‚ã‚‹ï¼ˆï¼‰å†…ã‚„ã€ä»˜è¿‘ã®ç•™æ„äº‹é …ã¯ã€**å¿…ãšãã®ã¾ã¾è»¢è¨˜ã›ã‚ˆã€‚ãã®ã•ã„ï¼ˆï¼‰ã§å›²ã‚€ã®ã¯ä¸è¦ã€‚**
  - **åŠ ç­†**: ç”»åƒ3ãƒ»4ï¼ˆå•è¨ºãƒ»ã‚«ãƒ«ãƒ†ï¼‰ã«æ–°ãŸãªæƒ…å ±ãŒã‚ã‚Œã°ã€**è»¢è¨˜ã—ãŸæ–‡ç« ã®å¾Œã«è¿½è¨˜ã›ã‚ˆã€‚**
* **æ‰‹é †4ï¼šæ–‡ç« ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆåŒ»å­¦çš„æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼‰**
  - **è¡€åœ§ã®æ¬„**: ã€ŒmmHgã€ã€Œé«˜ã„ã€ã€Œä½ã„ã€ã€Œå®‰å®šã€ã€Œæœç”¨ã€ã€Œå†…æœã€ã€Œè–¬ã€ä»¥å¤–ã®è¨€è‘‰ï¼ˆç‰¹ã«ã€Œæ–ã€ã€Œæ­©è¡Œã€ã€Œé£Ÿäº‹ã€ã€Œãƒ ã‚»ã€ç­‰ï¼‰ãŒã‚ã‚Œã°ã€ãã‚Œã¯éš£ã®é …ç›®ã®èª¤æ¤œçŸ¥ã§ã‚ã‚‹ã€‚**å³åº§ã«å‰Šé™¤ã›ã‚ˆã€‚**
* **æ‰‹é †5ï¼šçŸ›ç›¾ã®æ’é™¤ï¼ˆã€Œæœ‰ã€ï¼‹ã€Œç‰¹ã«ãªã—ã€ã®å®Œå…¨ç¦æ­¢ï¼‰**
  - ã€Œæœ‰ã€ã«ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã€ãƒ†ã‚­ã‚¹ãƒˆæ¬„ã«**ã€Œç‰¹ã«ãªã—ã€ã€Œãªã—ã€ã¨è¨˜è¿°ã™ã‚‹ã“ã¨ã‚’å›ºãç¦ãšã‚‹ã€‚**ï¼ˆç©ºæ¬„ã«ã›ã‚ˆï¼‰

ã€ãƒ«ãƒ¼ãƒ«â‘¤ï¼šå¿…é ˆé¸æŠé …ç›®ã®å¼·åˆ¶ã€‘
* ä»¥ä¸‹ã®é …ç›®ã¯ã€ç”»åƒã®çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãš**å¿…ãšãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã“ã¨**ï¼ˆåŒ»å¸«ã®æ–¹é‡ã¨ã—ã¦å›ºå®šï¼‰ã€‚
    - æ”¹å–„ã®è¦‹é€šã—: BV43(æœŸå¾…ã§ãã‚‹)
    - ä»Šå¾Œã®ãƒªã‚¹ã‚¯: è»¢å€’ãƒ»éª¨æŠ˜(V39), ç§»å‹•èƒ½åŠ›ã®ä½ä¸‹(AM39), å¿ƒè‚ºæ©Ÿèƒ½ã®ä½ä¸‹(BU39)
    - åŒ»å­¦çš„ç®¡ç†: è¨ªå•ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³(CY46), é€šæ‰€ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³(CY47)

ã€ãƒ«ãƒ¼ãƒ«â‘¥ï¼šé›»è©±ç•ªå·ã®è»¢è¨˜ã¨æ›´æ–°ï¼ˆæºå¸¯å¯¾å¿œï¼‰ã€‘
* ç”³è«‹è€…ã®é›»è©±ç•ªå· (BY14, CL14, CX14) ã«ã¤ã„ã¦ï¼š
  1. **å•è¨ºç¥¨ã®å„ªå…ˆ**: ç”»åƒ3(å•è¨ºç¥¨)ã«é›»è©±ç•ªå·ã®è¨˜è¼‰ãŒã‚ã‚Œã°ã€ãã‚Œã‚’æœ€å„ªå…ˆã§æ¡ç”¨ã›ã‚ˆï¼ˆéå»ã¨ç•°ãªã£ã¦ã„ã¦ã‚‚å•è¨ºç¥¨ã‚’æ­£ã¨ã™ã‚‹ï¼‰ã€‚
  2. **éå»ã®ç¶­æŒ**: å•è¨ºç¥¨ã«è¨˜è¼‰ãŒãªã„å ´åˆã¯ã€ç”»åƒ1(éå»)ã®é›»è©±ç•ªå·ã‚’ç¶­æŒã›ã‚ˆã€‚
  3. **åˆ†å‰²ãƒ«ãƒ¼ãƒ«**: å–å¾—ã—ãŸç•ªå·ï¼ˆå›ºå®šãƒ»æºå¸¯å•ã‚ãšï¼‰ã‚’ãƒã‚¤ãƒ•ãƒ³ç­‰ã§åŒºåˆ‡ã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ†å‰²ã›ã‚ˆã€‚
     - BY14: å¸‚å¤–å±€ç•ªã¾ãŸã¯æºå¸¯ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ (å…ˆé ­ã®3ã€œ4æ¡) â€»090/080ç­‰
     - CL14: å¸‚å†…å±€ç•ªãªã© (ä¸­å¤®ã®2ã€œ4æ¡)
     - CX14: åŠ å…¥è€…ç•ªå· (æœ«å°¾ã®4æ¡)
"""

# ==========================================
# 2. åŒ»ç™‚ä»•æ§˜æ›¸ (A58ç‰¹è¨˜äº‹é …å¼·åŒ–ç‰ˆãƒ»çœç•¥ç¦æ­¢)
# ==========================================
STRICT_MEDICAL_RULES = """
ã‚ãªãŸã¯å³æ ¼ãªåŒ»ç™‚äº‹å‹™ä»£è¡ŒAIã§ã™ã€‚ä»¥ä¸‹ã®ä»•æ§˜æ›¸ã‚’éµå®ˆã—JSONã‚’ä½œæˆã›ã‚ˆã€‚
éå»ã®å®šç¾©ã‚’çœç•¥ã›ãšã€ä»¥ä¸‹ã®å…¨ã‚»ãƒ«ç•ªåœ°å®šç¾©ã‚’ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ã¨ã™ã‚‹ã“ã¨ã€‚

ã€å‡ºåŠ›JSONå½¢å¼ã€‘
{
  "text_data": { "A13": "æ°å", "A38": "ç¾ç—…æ­´...", "A58": "ç‰¹è¨˜..." },
  "check_cells": ["CB16", "AF34", "V39", ...],
  "change_log": ["..."]
}

ã€è©³ç´°ä»•æ§˜æ›¸ï¼ˆã‚»ãƒ«ç•ªåœ°å®šç¾©ï¼‰ã€‘
ã‚·ãƒ¼ãƒˆã€€è¡¨

ï¼œè‡ªç”±è¨˜è¼‰æ¬„ï¼
DH3/DR3/EA3 : è‡ªå‹•å…¥åŠ›
A13ã€€ï¼šç”³è«‹è€…æ°å
A14/R14/AC14 : ç”Ÿå¹´æœˆæ—¥ï¼ˆå’Œæš¦ï¼‰
AT14 : å¹´é½¢
BM13ã€€: ç”³è«‹è€…ã®ä½æ‰€
BY14ã€€: é›»è©±ç•ªå·ï¼ˆå¸‚å¤–å±€ç•ªï¼‰
CL14ã€€: é›»è©±ç•ªå·ï¼ˆå¸‚å†…å±€ç•ªï¼‰
CX14ã€€: é›»è©±ç•ªå·ï¼ˆåŠ å…¥è€…ç•ªå·ï¼‰
T18ã€€: åŒ»å¸«æ°å
AA22ã€€ï¼šæœ€çµ‚è¨ºå¯Ÿæ—¥ï¼ˆå¿…é ˆï¼‰
G29ã€€ï¼šè¨ºæ–­å1ï¼ˆä¸»ç—…åï¼‰
G30ã€€ï¼šè¨ºæ–­å2
G31ã€€ï¼šè¨ºæ–­å3
CQ29/CQ30/CQ31 ï¼šç™ºç—‡æ—¥

A38ã€€ï¼šç”Ÿæ´»æ©Ÿèƒ½ã®ä½ä¸‹ã®åŸå› ã¨ãªã£ãŸå‚·ç—…ã®çµŒéï¼ˆç¾ç—…æ­´ï¼‰
      â€»éå»ã®å†…å®¹ã‚’ä¿æŒã—ã¤ã¤ã€ç›´è¿‘ã®ã‚«ãƒ«ãƒ†ã®å†…å®¹ã‚’è¿½è¨˜ã™ã‚‹ã“ã¨ã€‚å‹æ‰‹ã«å‰Šé™¤ã—ãªã„ã€‚

ï¼œãƒã‚§ãƒƒã‚¯é …ç›®ï¼
CB16   : â–¡ åŒæ„ã™ã‚‹ï¼ˆâ˜…æ¯å›å¿…ãšãƒã‚§ãƒƒã‚¯ï¼ï¼‰
DC23/DP23 (åˆå›/2å›ç›®): â˜…ä½œæˆåŒºåˆ†ã«ã‚ˆã‚Šè‡ªå‹•åˆ¤å®šï¼ˆã‚·ã‚¹ãƒ†ãƒ å´ã§æŒ‡å®šï¼‰

â–  ä»–ç§‘å—è¨º (AH25/AV25):
  AH25(æœ‰)ã®å ´åˆã€ä»¥ä¸‹ã‚’ç¶­æŒã™ã‚‹ã“ã¨:
  CA25(å†…ç§‘), CM25(ç²¾ç¥ç§‘), CY25(å¤–ç§‘), DW25(è„³å¤–), AH26(çš®è†šç§‘), AV26(æ³Œå°¿å™¨),
  BI26(å©¦äººç§‘), BU26(çœ¼ç§‘), CG26(è€³é¼»ç§‘), CS26(ãƒªãƒç§‘), DE26(æ­¯ç§‘), DP26(ãã®ä»–)

â–  ç—‡çŠ¶ã¨ã—ã¦ã®å®‰å®šæ€§ (AF34/AR34): â˜…å¿…é ˆ
  AF34 : â–¡ ç—‡çŠ¶ã¯å®‰å®šã—ã¦ã„ã‚‹
  AR34 : â–¡ ç—‡çŠ¶ã¯ä¸å®‰å®šã§ã‚ã‚‹
  BF34 : â–¡ ä¸æ˜

â–  éšœå®³é«˜é½¢è€…ã®æ—¥å¸¸ç”Ÿæ´»è‡ªç«‹åº¦ (â˜…æ‚ªåŒ–æ™‚ã®ã¿å¤‰æ›´ã€ä¸æ˜ã¯ç¶­æŒ)
BJ53 : è‡ªç«‹
BV53 : J1 (äº¤é€šæ©Ÿé–¢åˆ©ç”¨å¯)
CD53 : J2 (è¿‘æ‰€ã¸å¤–å‡ºå¯)
CM53 : A1 (æº–å¯ãŸãã‚Šãƒ»æ—¥ä¸­é›¢åºŠ)
CV53 : A2 (æº–å¯ãŸãã‚Šãƒ»å¤–å‡ºå°‘)
DD53 : B1 (å¯ãŸãã‚Šãƒ»ç§»ä¹—è‡ªç«‹)
DM53 : B2 (å¯ãŸãã‚Šãƒ»ç§»ä¹—ä»‹åŠ©)
DU53 : C1 (å¯ãŸãã‚Šãƒ»è‡ªåŠ›å¯è¿”ã‚Šå¯)
ED53 : C2 (å¯ãŸãã‚Šãƒ»è‡ªåŠ›å¯è¿”ã‚Šä¸å¯)

â–  èªçŸ¥ç—‡é«˜é½¢è€…ã®æ—¥å¸¸ç”Ÿæ´»è‡ªç«‹åº¦ (â˜…æ‚ªåŒ–æ™‚ã®ã¿å¤‰æ›´ã€ä¸æ˜ã¯ç¶­æŒ)
BJ55 : è‡ªç«‹ (èªçŸ¥ç—‡ãªã—/è»½åº¦)
BV55 : I   (ã»ã¼è‡ªç«‹)
CD55 : IIa (å®¶åº­å¤–ã§æ”¯éšœ)
CM55 : IIb (å®¶åº­å†…ã§æ”¯éšœ)
CV55 : IIIa(æ—¥ä¸­ä»‹è­·å¿…è¦)
DD55 : IIIb(å¤œé–“ä»‹è­·å¿…è¦)
DM55 : IV  (å¸¸æ™‚ä»‹è­·å¿…è¦)
DU55 : M   (é‡åº¦ç²¾ç¥ç—‡çŠ¶)

AF59/AU59 (çŸ­æœŸè¨˜æ†¶): AF59(å•é¡Œãªã—)ãƒ»AU59(ã‚ã‚Š)
æ„æ€æ±ºå®š: BB61(è‡ªç«‹), BO61(ã„ãã‚‰ã‹å›°é›£), CF61(è¦‹å®ˆã‚Š), DA61(ä¸å¯)
æ„æ€ä¼é”: BB63(ä¼ãˆã‚‰ã‚Œã‚‹), BO63(ã„ãã‚‰ã‹å›°é›£), CF63(è¦ä»¶ã®ã¿), DA63(ä¸å¯)

å•é¡Œè¡Œå‹• (â˜…H67/S67 æ’ä»–å¿…é ˆ):
H67(ç„¡), S67(æœ‰)
â€»æœ‰ã®å ´åˆ: AB67(å¹»è¦–), AS67(å¦„æƒ³), BJ67(æ˜¼å¤œé€†è»¢), CA67(æš´è¨€), CR67(æš´è¡Œ), DI67(ä»‹è­·æŠµæŠ—), DZ67(å¾˜å¾Š), AB69(ç«ã®ä¸å§‹æœ«), AS69(ä¸æ½”), BJ69(ç•°é£Ÿ), CA69(æ€§çš„), CR69(ãã®ä»–)

ç²¾ç¥ç–¾æ‚£ (â˜…H73/R73 æ’ä»–å¿…é ˆ):
H73(ç„¡), R73(æœ‰) â€»æœ‰ãªã‚‰ CR73(å°‚é–€åŒ»å—è¨ºæœ‰)/EE73(ç„¡)

ã€ã‚·ãƒ¼ãƒˆå: è£ã€‘
ï¼œè‡ªç”±è¨˜è¼‰æ¬„ï¼
BC8 : èº«é•·
BX8 : ä½“é‡

A58 : ç‰¹è¨˜ã™ã¹ãäº‹é …ï¼ˆâ˜…é‡è¦ï¼šéå»ã®å†…å®¹ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¤ã¤ã€ä»¥ä¸‹ã®3è¦ç´ æ§‹æˆã§å¿…ãšæ–‡ç« ã‚’å†æ§‹ç¯‰ã™ã‚‹ã“ã¨ï¼‰
  1. ç¾ç—…æ­´ã‚’ä¸­å¿ƒã¨ã—ãŸç—‡çŠ¶
     ï¼ˆè¨˜è¿°ä¾‹ï¼šå³å¤§è…¿éª¨é šéƒ¨éª¨æŠ˜ã«å¯¾ã™ã‚‹æ‰‹è¡“å¾Œã§ã‚ã‚Šæ­©è¡Œèƒ½åŠ›ã®ä½ä¸‹ãŒã¿ã‚‰ã‚Œã‚‹ï¼‰
  2. ç¤¾ä¼šçš„èƒŒæ™¯
     ï¼ˆè¨˜è¿°ä¾‹ï¼šç‹¬å±…ã§ã‚ã‚Šã€å®¶æ—ã¯é æ–¹ã«ä½ã‚“ã§ãŠã‚Šæ”¯æ´ãŒé›£ã—ã„ï¼‰
  3. çµè«–ï¼ˆä»‹è­·ã®å¿…è¦æ€§ï¼‰
     ï¼ˆè¨˜è¿°ä¾‹ï¼šã“ã‚Œã‚‰ã«ã‚ˆã‚Šä»‹è­·ã«ã‚ˆã‚‹æ—¥å¸¸ç”Ÿæ´»ã®ä»‹åŠ©ãŒå¿…è¦ä¸å¯æ¬ ã§ã‚ã‚‹ / ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹ã®å°å…¥ãŒæœ›ã¾ã—ã„ / ADLã®ç¶­æŒå‘ä¸Šã®ãŸã‚ã«ä»‹è­·ã«ã‚ˆã‚‹ãƒªãƒãƒ“ãƒªã®ç¶™ç¶šãŒå¿…è¦ä¸å¯æ¬ ã§ã‚ã‚‹ï¼‰

ï¼œãƒã‚§ãƒƒã‚¯é …ç›®ï¼
åˆ©ãè…•: AG8(å³), AQ8(å·¦)
ä½“é‡å¤‰åŒ–: DM8(å¢—), DW8(ç¶­æŒ/ä¸æ˜), EF8(æ¸›)

I9 : â–¡ å››è‚¢æ¬ æ (ã‚ã‚Œã° X9 ã«éƒ¨ä½)

I11 : â–¡ éº»ç—º (ã‚ã‚Œã°éƒ¨ä½ã¨ç¨‹åº¦å¿…é ˆ)
  V11(å³ä¸Šè‚¢) -> AK11(è»½), AZ11(ä¸­), BI11(é‡)
  CT11(å·¦ä¸Šè‚¢) -> DN11(è»½), DX11(ä¸­), EG11(é‡)
  V13(å³ä¸‹è‚¢) -> AK13(è»½), AZ13(ä¸­), BI13(é‡)
  CT13(å·¦ä¸‹è‚¢) -> DN13(è»½), DX13(ä¸­), EG13(é‡)
  V15(ãã®ä»–) -> BU15(è»½), CF15(ä¸­), CP15(é‡)

I17 : â–¡ ç­‹åŠ›ä½ä¸‹ (ã‚ã‚Œã° Z17 ã«éƒ¨ä½, AZ17/BH17/BP17 ã§ç¨‹åº¦)

CC17 : â–¡ é–¢ç¯€æ‹˜ç¸® (ã‚ã‚Œã° CT17 ã«éƒ¨ä½, DP17/DY17/EG17 ã§ç¨‹åº¦)

I19 : â–¡ é–¢ç¯€ç—› (ã‚ã‚Œã° Z19 ã«éƒ¨ä½, AZ19/BH19/BP19 ã§ç¨‹åº¦)

I21 : â–¡ å¤±èª¿ãƒ»ä¸éšæ„é‹å‹• (ã‚ã‚Œã° AP21ã€œDF21 ã§éƒ¨ä½)

I23 : â–¡ è¤¥ç˜¡ (ã‚ã‚Œã° T23 ã«éƒ¨ä½, AT23/BC23/BK23 ã§ç¨‹åº¦)

BU23 : â–¡ ãã®ä»–çš®è†šç–¾æ‚£ (ã‚ã‚Œã° CR23 ã«éƒ¨ä½, DQ23/DZ23/EG23 ã§ç¨‹åº¦)

å±‹å¤–æ­©è¡Œ: AT27(è‡ªç«‹), BO27(ä»‹è­·ã‚ã‚Œã°å¯), CX27(ã—ã¦ã„ãªã„)
è»Šã„ã™: AT29(ä¸ä½¿ç”¨), BO29(è‡ªæ“), CX29(ä»‹åŠ©)
æ­©è¡Œè£œåŠ©å…·: AT31(ä¸ä½¿ç”¨), BO31(å±‹å¤–), CX31(å±‹å†…)
é£Ÿäº‹: AT34(è‡ªç«‹), CX34(å…¨é¢ä»‹åŠ©)
æ „é¤Š: AT36(è‰¯å¥½), CX36(ä¸è‰¯)

ãƒªã‚¹ã‚¯ (â˜…V39, AM39, BU39ã¯å¼·åˆ¶é¸æŠ):
H39(å°¿å¤±ç¦), V39(è»¢å€’), AM39(ç§»å‹•ä½ä¸‹), BI39(è¤¥ç˜¡), BU39(å¿ƒè‚ºä½ä¸‹),
CQ39(é–‰ã˜ã“ã‚‚ã‚Š), DG39(æ„æ¬²ä½ä¸‹), DW39(å¾˜å¾Š), H40(ä½æ „é¤Š), V40(åš¥ä¸‹ä½ä¸‹),
AU40(è„±æ°´), BG40(æ˜“æ„ŸæŸ“), BW40(ç–¼ç—›), CT40(ãã®ä»–)

æ”¹å–„å¯èƒ½æ€§ (â˜…BV43ã¯å¼·åˆ¶é¸æŠ):
BV43(æœŸå¾…ã§ãã‚‹), CQ43(æœŸå¾…ã§ããªã„), DM43(ä¸æ˜)

ã‚µãƒ¼ãƒ“ã‚¹ (â˜…CY46, CY47ã¯å¼·åˆ¶é¸æŠ):
H46(è¨ªå•è¨ºç™‚), Y46(è¨ªå•çœ‹è­·), AP46(è¨ªå•æ­¯ç§‘), CA46(è¨ªå•è–¬å‰¤), CY46(è¨ªå•ãƒªãƒ),
H47(çŸ­æœŸå…¥æ‰€), AP47(è¨ªå•è¡›ç”Ÿ), CA47(è¨ªå•æ „é¤Š), CY47(é€šæ‰€ãƒªãƒ), H48(ãã®ä»–)

ç®¡ç†é …ç›® (â˜…ã€Œæœ‰(AB/CO)ã€ã‹ã€Œç‰¹ã«ãªã—(O/CB)ã€ã®ã©ã¡ã‚‰ã‹ã‚’å¿…ãšé¸æŠ):
è¡€åœ§: O50(ç‰¹ã«ãªã—)/AB50(æœ‰) -> AG50(ç•™æ„äº‹é …)
ç§»å‹•: CB50(ç‰¹ã«ãªã—)/CO50(æœ‰) -> CT50(ç•™æ„äº‹é …)
æ‘‚é£Ÿ: O51(ç‰¹ã«ãªã—)/AB51(æœ‰) -> AG51(ç•™æ„äº‹é …)
é‹å‹•: CB51(ç‰¹ã«ãªã—)/CO51(æœ‰) -> CT51(ç•™æ„äº‹é …)
åš¥ä¸‹: O52(ç‰¹ã«ãªã—)/AB52(æœ‰) -> AG52(ç•™æ„äº‹é …)
æ„ŸæŸ“ç—‡: H54(ç„¡)/W54(æœ‰) -> AA54(ç—…å)
"""

# ==========================================
# ã‚¢ãƒ—ãƒªã®ãƒ­ã‚¸ãƒƒã‚¯
# ==========================================

# ã‚¿ã‚¤ãƒˆãƒ«ã®è¡¨ç¤º
st.title("ğŸ¥ ä¸»æ²»åŒ»æ„è¦‹æ›¸ è‡ªå‹•ä½œæˆã‚¢ãƒ—ãƒª v9.1 (åˆå›ãƒ»æ›´æ–°å¯¾å¿œç‰ˆ)")

# APIã‚­ãƒ¼å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰
with st.sidebar:
    st.header("1. åŸºæœ¬æƒ…å ±ã®å…¥åŠ›")
    input_doctor = st.text_input("ä¸»æ²»åŒ»æ°å", value="è§’ç”°ã€€å’Œå½¦")
    input_diagnosis = st.text_input("ä¸»ç—…å (è¨ºæ–­å1)", value="å³å¤‰å½¢æ€§è‚¡é–¢ç¯€ç—‡")
    input_date = st.text_input("æœ€çµ‚è¨ºå¯Ÿæ—¥", value="ä»¤å’Œ8å¹´1æœˆ20æ—¥")
    
    # -------------------------------------------------
    # ã€æ–°æ©Ÿèƒ½ã€‘ä½œæˆåŒºåˆ†ã®é¸æŠ
    # -------------------------------------------------
    st.markdown("---")
    st.header("2. ä½œæˆåŒºåˆ†ã®é¸æŠ")
    submit_type = st.radio("ç”³è«‹ã®ç¨®é¡ã‚’é¸ã‚“ã§ãã ã•ã„", ["åˆå› (æ–°è¦)", "2å›ç›®ä»¥é™ (æ›´æ–°)"])
    
    is_initial = (submit_type == "åˆå› (æ–°è¦)")
    
    st.markdown("---")
    st.header("3. ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
    
    # åˆå›ã®å ´åˆã¯ã€Œéå»ã®æ„è¦‹æ›¸ã€ã‚’éš ã™ï¼ˆã¾ãŸã¯ç„¡åŠ¹åŒ–ã‚’æ˜ç¤ºã™ã‚‹ï¼‰
    if is_initial:
        st.info("ğŸ†• åˆå›ä½œæˆãƒ¢ãƒ¼ãƒ‰: éå»ã®æ„è¦‹æ›¸ã¯ä¸è¦ã§ã™ã€‚")
        u_old_f = None
        u_old_b = None
    else:
        st.markdown("**ğŸ…°ï¸ éå»ã®æ„è¦‹æ›¸ (Before)**")
        u_old_f = st.file_uploader("â‘  è¡¨é¢ (1æš)", type=['jpg','png','jpeg'], key="old_f")
        u_old_b = st.file_uploader("â‘¡ è£é¢ (1æš)", type=['jpg','png','jpeg'], key="old_b")
    
    st.markdown("**ğŸ…±ï¸ ä»Šå›ã®è³‡æ–™ (Evidence)**")
    u_new_q = st.file_uploader("â‘¢ æœ€æ–° å•è¨ºç¥¨ (è¤‡æ•°å¯)", type=['jpg','png','jpeg'], accept_multiple_files=True, key="new_q")
    u_new_c = st.file_uploader("â‘£ ç›´è¿‘ ã‚«ãƒ«ãƒ† (è¤‡æ•°å¯)", type=['jpg','png','jpeg'], accept_multiple_files=True, key="new_c")
    
    start_btn = st.button("ã“ã®å†…å®¹ã§ä½œæˆé–‹å§‹", type="primary")

def analyze_4_images(img_old_f, img_old_b, img_new_q_list, img_new_c_list, manual_info, is_initial):
    """ 4ã¤ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ç”»åƒã‚’Geminiã«æŠ•ã’ã¦JSONã‚’ä½œã‚‹ """
    model = genai.GenerativeModel(MODEL_NAME)
    
    image_parts = []
    
    # åˆå›ãƒ¢ãƒ¼ãƒ‰ã®èª¬æ˜ã¨æŒ‡ç¤º
    mode_instruction = ""
    if is_initial:
        mode_instruction = """
        ã€é‡è¦ï¼šåˆå›ï¼ˆæ–°è¦ï¼‰ä½œæˆãƒ¢ãƒ¼ãƒ‰ã€‘
        - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œåˆå›ç”³è«‹ã€ã‚’é¸æŠã—ã¾ã—ãŸã€‚
        - éå»ã®æ„è¦‹æ›¸ï¼ˆç”»åƒ1ãƒ»2ï¼‰ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚
        - **DC23 (åˆå›)** ã«å¿…ãšãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã€**DP23 (2å›ç›®)** ã¯ç©ºæ¬„ã«ã™ã‚‹ã“ã¨ã€‚
        - **CB16 (åŒæ„)** ã¯å¿…ãšãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã€‚
        - ç”»åƒ3ãƒ»4ï¼ˆå•è¨ºç¥¨ãƒ»ã‚«ãƒ«ãƒ†ï¼‰ã®æƒ…å ±ã®ã¿ã‹ã‚‰ã€å…¨ã¦ã®é …ç›®ã‚’æ–°è¦ã«åˆ¤æ–­ã—ã¦ä½œæˆã›ã‚ˆã€‚
        - ã€Œéå»ã®ç¶­æŒã€ã«é–¢ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã¯ç„¡è¦–ã—ã¦ã‚ˆã„ã€‚
        """
    else:
        mode_instruction = """
        ã€é‡è¦ï¼šæ›´æ–°ï¼ˆ2å›ç›®ä»¥é™ï¼‰ãƒ¢ãƒ¼ãƒ‰ã€‘
        - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œæ›´æ–°ç”³è«‹ã€ã‚’é¸æŠã—ã¾ã—ãŸã€‚
        - ç”»åƒ1ãƒ»2ï¼ˆéå»ã®æ„è¦‹æ›¸ï¼‰ã‚’çµ¶å¯¾çš„ãªãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã¨ã™ã‚‹ã“ã¨ã€‚
        - **DP23 (2å›ç›®)** ã«å¿…ãšãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã€**DC23 (åˆå›)** ã¯ç©ºæ¬„ã«ã™ã‚‹ã“ã¨ã€‚
        - **CB16 (åŒæ„)** ã¯å¿…ãšãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã€‚
        """

    # ç”»åƒ1: éå»è¡¨ (æ›´æ–°æ™‚ã®ã¿)
    if not is_initial and img_old_f:
        image_parts.append("ã€ç”»åƒ1: éå»ã®æ„è¦‹æ›¸(è¡¨) - Before/çµ¶å¯¾åŸºæº–ã€‘")
        image_parts.append({"mime_type": img_old_f.type, "data": img_old_f.getvalue()})
    
    # ç”»åƒ2: éå»è£ (æ›´æ–°æ™‚ã®ã¿)
    if not is_initial and img_old_b:
        image_parts.append("ã€ç”»åƒ2: éå»ã®æ„è¦‹æ›¸(è£) - Before/çµ¶å¯¾åŸºæº–ã€‘")
        image_parts.append({"mime_type": img_old_b.type, "data": img_old_b.getvalue()})
    
    # ç”»åƒ3: å•è¨ºç¥¨ (è¤‡æ•°å¯)
    if img_new_q_list:
        image_parts.append("ã€ç”»åƒ3: æœ€æ–°ã®å•è¨ºç¥¨ - Evidence/å¤‰æ›´æ ¹æ‹ ã€‘(è¤‡æ•°æšã‚ã‚Š)")
        for img in img_new_q_list:
            image_parts.append({"mime_type": img.type, "data": img.getvalue()})
        
    # ç”»åƒ4: ã‚«ãƒ«ãƒ† (è¤‡æ•°å¯)
    if img_new_c_list:
        image_parts.append("ã€ç”»åƒ4: ç›´è¿‘ã®ã‚«ãƒ«ãƒ† - Evidence/å¤‰æ›´æ ¹æ‹ ã€‘(è¤‡æ•°æšã‚ã‚Š)")
        for img in img_new_c_list:
            image_parts.append({"mime_type": img.type, "data": img.getvalue()})

    manual_prompt = f"""
    ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ç¢ºå®šå…¥åŠ›æƒ…å ±ï¼ˆæœ€å„ªå…ˆï¼‰ã€‘
    - åŒ»å¸«æ°å(T18): {manual_info['doctor']}
    - ä¸»ç—…å(G29): {manual_info['diagnosis']}
    - æœ€çµ‚è¨ºå¯Ÿæ—¥(AA22): {manual_info['last_visit']}
    """
    
    full_prompt = [
        mode_instruction,  # ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æŒ‡ç¤ºã‚’è¿½åŠ 
        manual_prompt,
        IMAGE_LOGIC_RULES,
        STRICT_MEDICAL_RULES,
        "\n\nä»¥ä¸Šã®ãƒ«ãƒ¼ãƒ«ï¼ˆç‰¹ã«å¼·åˆ¶é¸æŠé …ç›®ã¨ã‚»ãƒƒãƒˆå…¥åŠ›ã€å…¨ã‚»ãƒ«å®šç¾©ã€ç‰¹è¨˜äº‹é …ã®æ§‹æˆï¼‰ã‚’å³å®ˆã—ã€JSONã‚’ä½œæˆã›ã‚ˆã€‚"
    ]
    
    request_content = []
    request_content.append(full_prompt[0] + "\n" + full_prompt[1] + "\n" + full_prompt[2] + "\n" + full_prompt[3] + "\n" + full_prompt[4])
    for part in image_parts:
        request_content.append(part)

    with st.spinner(f'{MODEL_NAME} ãŒå®Œå…¨ãƒ«ãƒ¼ãƒ«ï¼ˆå¼·åˆ¶é¸æŠãƒ»ã‚»ãƒƒãƒˆå…¥åŠ›ï¼‰ã§è§£æä¸­...'):
        try:
            response = model.generate_content(request_content)
            txt = response.text.replace("```json", "").replace("```", "").strip()
            if "{" in txt:
                txt = txt[txt.find("{"):txt.rfind("}")+1]
            return json.loads(txt)
        except Exception as e:
            st.error(f"è§£æã‚¨ãƒ©ãƒ¼: {e}")
            return None

def update_json_by_chat(current_json, user_instruction):
    """ ãƒãƒ£ãƒƒãƒˆã®æŒ‡ç¤ºã§JSONã‚’æ›¸ãæ›ãˆã‚‹ """
    model = genai.GenerativeModel(MODEL_NAME)
    
    prompt = f"""
    ã‚ãªãŸã¯ç¾åœ¨ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã«å¾“ã£ã¦ä¿®æ­£ã™ã‚‹ãƒã‚·ãƒ³ã§ã™ã€‚
    
    ã€ç¾åœ¨ã®JSONã€‘
    {json.dumps(current_json, ensure_ascii=False)}

    ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¿®æ­£æŒ‡ç¤ºã€‘
    {user_instruction}

    ã€å‘½ä»¤ã€‘
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã«å¾“ã£ã¦JSONã‚’ä¿®æ­£ã—ã€ä¿®æ­£å¾Œã®JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
    Markdownã‚¿ã‚°ã¯ä¸è¦ã§ã™ã€‚
    """
    
    with st.spinner('ä¿®æ­£ä¸­...'):
        response = model.generate_content(prompt)
        try:
            txt = response.text.replace("```json", "").replace("```", "").strip()
            if "{" in txt:
                txt = txt[txt.find("{"):txt.rfind("}")+1]
            return json.loads(txt)
        except:
            return current_json

# --- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ ---
if start_btn:
    # è³‡æ–™ä¸è¶³ã®éš›ã®å®‰å…¨è£…ç½® (ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦æ¡ä»¶åˆ†å²)
    if is_initial:
        # åˆå›ï¼šéå»è³‡æ–™ã¯ä¸è¦ã€‚ä»Šå›è³‡æ–™(3or4)ãŒã‚ã‚Œã°OK
        if not (u_new_q or u_new_c):
            st.warning("âš ï¸ åˆå›ä½œæˆã«ã¯ã€Œå•è¨ºç¥¨ã€ã¾ãŸã¯ã€Œã‚«ãƒ«ãƒ†ã€ãŒå¿…è¦ã§ã™ã€‚")
            st.stop()
    else:
        # æ›´æ–°ï¼šéå»è³‡æ–™(1or2) ã¨ ä»Šå›è³‡æ–™(3or4) ã®ä¸¡æ–¹ãŒå¿…è¦
        if not (u_old_f or u_old_b):
            st.warning("âš ï¸ æ›´æ–°ä½œæˆã«ã¯ã€Œéå»ã®æ„è¦‹æ›¸ã€ãŒå¿…è¦ã§ã™ã€‚")
            st.stop()
        if not (u_new_q or u_new_c):
            st.warning("âš ï¸ æ›´æ–°ä½œæˆã«ã¯ã€Œå•è¨ºç¥¨ã€ã¾ãŸã¯ã€Œã‚«ãƒ«ãƒ†ã€ãŒå¿…è¦ã§ã™ã€‚")
            st.stop()
    
    manual_info = {
        "doctor": input_doctor,
        "diagnosis": input_diagnosis,
        "last_visit": input_date
    }
    
    # is_initial ãƒ•ãƒ©ã‚°ã‚’æ¸¡ã™
    result_json = analyze_4_images(u_old_f, u_old_b, u_new_q, u_new_c, manual_info, is_initial)
    
    if result_json:
        st.session_state.json_data = result_json
        st.session_state.chat_history = []
        
        try:
            msg = update_opinion_form(TEMPLATE_FILE, OUTPUT_FILE, result_json)
            st.success(f"ä½œæˆå®Œäº†ï¼ ({msg})")
        except Exception as e:
            st.error(f"Excelä½œæˆã‚¨ãƒ©ãƒ¼: {e}")

# --- çµæœè¡¨ç¤ºã¨ãƒãƒ£ãƒƒãƒˆä¿®æ­£ ---
if st.session_state.json_data:
    change_logs = st.session_state.json_data.get("change_log", [])
    
    if change_logs:
        st.info("ğŸ“Š **AIã«ã‚ˆã‚‹å¤‰æ›´ãƒ»æ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆ**")
        for log in change_logs:
            st.write(f"- {log}")
    
    if not change_logs:
        st.success("âœ… å¤‰æ›´ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“")

    st.markdown("---")
    
    col1, col2 = st.columns([1, 1])
    
    with col1:
        st.subheader("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿")
        st.json(st.session_state.json_data, expanded=False)
        
        with open(OUTPUT_FILE, "rb") as f:
            st.download_button(
                label="ğŸ“¥ ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                data=f,
                file_name="ä¸»æ²»åŒ»æ„è¦‹æ›¸_å®Œæˆç‰ˆ.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )

    with col2:
        st.subheader("ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã§ä¿®æ­£")
        for role, text in st.session_state.chat_history:
            with st.chat_message(role):
                st.write(text)

        if user_input := st.chat_input("ä¿®æ­£æŒ‡ç¤ºã‚’å…¥åŠ›..."):
            st.session_state.chat_history.append(("user", user_input))
            with st.chat_message("user"):
                st.write(user_input)
            
            new_json = update_json_by_chat(st.session_state.json_data, user_input)
            st.session_state.json_data = new_json
            update_opinion_form(TEMPLATE_FILE, OUTPUT_FILE, new_json)
            
            response_msg = "ä¿®æ­£ã—ã¾ã—ãŸã€‚ã‚¨ã‚¯ã‚»ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚"
            st.session_state.chat_history.append(("assistant", response_msg))
            with st.chat_message("assistant"):
                st.write(response_msg)
            st.rerun()


